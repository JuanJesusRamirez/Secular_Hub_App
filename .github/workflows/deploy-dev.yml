name: Deploy to Dev

on:
  workflow_run:
    workflows: [ "Build and Push Image" ]
    types: [ completed ]
    branches: [ dev ]

permissions:
  id-token: write
  contents: read

env:
  ACR_NAME: acrsecularhubshared
  TERRAFORM_DIR: terraform
  TFSTATE_RG: rg-secular-hub-tfstate
  TFSTATE_SA: secularhubtfst20260108
  TFSTATE_CONTAINER: tfstate

jobs:
  deploy-dev:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
      
      - name: Set image tag from workflow run
        id: image-tag
        run: |
          # Extract commit SHA from the workflow run that triggered this
          echo "IMAGE_TAG=${{ github.event.workflow_run.head_commit }}" >> $GITHUB_OUTPUT
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.5.7"
      
      - name: Terraform Init
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ env.TFSTATE_RG }}" \
            -backend-config="storage_account_name=${{ env.TFSTATE_SA }}" \
            -backend-config="container_name=${{ env.TFSTATE_CONTAINER }}" \
            -reconfigure
      
      - name: Terraform Plan
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          terraform plan \
            -var-file="../envs/dev.tfvars" \
            -var="image_tag=${{ steps.image-tag.outputs.IMAGE_TAG }}" \
            -out=tfplan
      
      - name: Terraform Apply
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          terraform apply -auto-approve tfplan
      
      - name: Capture outputs
        id: tf-outputs
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          FQDN=$(terraform output -raw container_app_fqdn)
          ACR_SERVER=$(terraform output -raw acr_login_server)
          echo "CONTAINER_APP_FQDN=$FQDN" >> $GITHUB_OUTPUT
          echo "ACR_LOGIN_SERVER=$ACR_SERVER" >> $GITHUB_OUTPUT
      
      - name: Verify deployment
        run: |
          echo "Dev deployment complete!"
          echo "Container App FQDN: ${{ steps.tf-outputs.outputs.CONTAINER_APP_FQDN }}"
          echo "Image published to: ${{ steps.tf-outputs.outputs.ACR_LOGIN_SERVER }}/secular-hub:${{ steps.image-tag.outputs.IMAGE_TAG }}"
